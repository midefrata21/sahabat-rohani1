<!DOCTYPE html>
<html lang="id">
<head>a
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahabat Rohani GPIB Nehemia</title>
    
    <!-- Meta Description & SEO -->
    <meta name="description" content="Dapatkan ayat Alkitab harian, renungan personal, dan bimbingan rohani cerdas berbasis AI untuk jemaat GPIB Nehemia Cibogo.">
    
    <!-- Fonts & Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Lora:ital,wght@0,400..700;1,400..700&family=Great+Vibes&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --cute-blue: #e0f2fe;
            --cute-pink: #fce7f3;
            --cute-yellow: #fef3c7;
            --gpib-blue: #1e40af;
            --gpib-accent: #d4af37;
        }
        
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: #334155;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .font-serif { font-family: 'Lora', serif; }
        .font-script { font-family: 'Great Vibes', cursive; }
        
        /* Animations */
        .floating { animation: float 6s ease-in-out infinite; }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .shine { animation: shine 3s infinite; }
        @keyframes shine {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom UI Elements */
        .custom-header {
            position: relative;
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 50%, #60a5fa 100%);
            color: white;
            border-bottom-left-radius: 4rem;
            border-bottom-right-radius: 4rem;
            box-shadow: 0 20px 40px -10px rgba(30, 64, 175, 0.4);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        }

        .input-field {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 1rem;
            border: 2px solid transparent;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .option-btn:hover { transform: translateY(-2px); border-color: #cbd5e1; }
        .option-btn.active {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        /* Poster Styling */
        #poster-container {
            width: 100%;
            max-width: 380px;
            aspect-ratio: 1 / 1;
            position: relative;
            overflow: hidden;
            border-radius: 1.5rem;
            background-color: #1e3a8a;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            margin: 0 auto;
        }
        
        .poster-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            transition: transform 0.5s ease;
        }
        
        .poster-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(30, 58, 138, 0.4), rgba(30, 58, 138, 0.9));
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #toast-container.show {
            top: 40px;
            opacity: 1;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Typography utility for API text */
        .prose-custom p { margin-bottom: 0.75rem; }
        .prose-custom strong { color: #1e3a8a; font-weight: 700; }
    </style>
</head>
<body class="pb-24 antialiased">

    <!-- Toast Notification -->
    <div id="toast-container" class="bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 text-sm font-medium backdrop-blur-md bg-opacity-90">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        <span id="toast-message">Notifikasi</span>
    </div>

    <!-- Header -->
    <header class="custom-header pt-12 pb-24 px-6 text-center overflow-visible">
        <div class="absolute top-0 left-0 w-full h-full opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] rounded-b-[4rem]"></div>
        
        <div class="relative z-10 flex flex-col items-center">
            
            <!-- ICON GEREJA (Header) -->
            <div class="floating mb-4 relative group">
                <div class="absolute inset-0 bg-white/30 rounded-3xl blur-xl transform group-hover:scale-110 transition-transform"></div>
                <div class="w-36 h-36 md:w-40 md:h-40 p-2 bg-white/20 backdrop-blur-md border border-white/40 shine overflow-hidden shadow-2xl relative rounded-3xl">
                   <!-- Ikon Gereja -->
                   <div class="w-full h-full bg-gradient-to-br from-white to-blue-50 rounded-2xl flex items-center justify-center text-blue-800 transform group-hover:scale-105 transition-transform duration-700">
                        <i data-lucide="church" class="w-20 h-20 md:w-24 md:h-24 stroke-[1.5]"></i>
                   </div>
                </div>
            </div>

            <h1 class="text-3xl md:text-5xl font-bold mb-2 tracking-tight drop-shadow-md font-serif">Sahabat Rohani</h1>
            <div class="flex items-center gap-2 justify-center opacity-90">
                <div class="h-[1px] w-8 bg-blue-200"></div>
                <p class="text-blue-50 text-xs md:text-sm font-bold uppercase tracking-[0.2em] text-shadow-sm">GPIB Nehemia Cibogo</p>
                <div class="h-[1px] w-8 bg-blue-200"></div>
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto px-4 -mt-16 relative z-20 space-y-6">
        
        <!-- Input Section -->
        <section id="input-section" class="glass-card p-6 md:p-8 fade-in">
            <div class="text-center mb-6">
                <span class="inline-block py-1 px-3 rounded-full bg-blue-50 text-blue-600 text-[10px] font-bold uppercase tracking-wider mb-2">Renungan Harian</span>
                <h2 class="text-xl font-bold text-slate-800">Apa Kabar Hari Ini?</h2>
                <p class="text-slate-500 text-xs mt-1">Ceritakan sedikit, biar kami pilihkan Firman untukmu.</p>
            </div>
            
            <div class="space-y-6">
                <!-- Name Input -->
                <div class="group">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Nama Panggilan</label>
                    <div class="relative">
                        <i data-lucide="user" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                        <input type="text" id="userName" placeholder="Ketik namamu..." 
                            class="w-full pl-12 pr-4 py-3 input-field text-sm font-semibold text-slate-700 placeholder:text-slate-300">
                    </div>
                </div>

                <!-- Activity Selection -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Aktivitas</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setOption('activity', 'Bekerja', this)" class="option-btn activity-btn p-3 flex items-center justify-center gap-2">
                            <i data-lucide="briefcase" class="w-4 h-4 text-blue-500"></i> <span class="text-xs font-semibold">Bekerja</span>
                        </button>
                        <button onclick="setOption('activity', 'Belajar', this)" class="option-btn activity-btn p-3 flex items-center justify-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4 text-pink-500"></i> <span class="text-xs font-semibold">Belajar</span>
                        </button>
                        <button onclick="setOption('activity', 'Istirahat', this)" class="option-btn activity-btn p-3 flex items-center justify-center gap-2">
                            <i data-lucide="coffee" class="w-4 h-4 text-amber-600"></i> <span class="text-xs font-semibold">Istirahat</span>
                        </button>
                        <button onclick="setOption('activity', 'Pergumulan', this)" class="option-btn activity-btn p-3 flex items-center justify-center gap-2">
                            <i data-lucide="heart-handshake" class="w-4 h-4 text-violet-500"></i> <span class="text-xs font-semibold">Pergumulan</span>
                        </button>
                        <button onclick="setOption('activity', 'Sakit', this)" class="option-btn activity-btn p-3 flex items-center justify-center gap-2">
                            <i data-lucide="thermometer" class="w-4 h-4 text-red-500"></i> <span class="text-xs font-semibold">Sakit</span>
                        </button>
                        <button onclick="setOption('activity', 'Mencari Pekerjaan', this)" class="option-btn activity-btn p-3 flex items-center justify-center gap-2">
                            <i data-lucide="search" class="w-4 h-4 text-sky-500"></i> <span class="text-xs font-semibold">Cari Kerja</span>
                        </button>
                        <button onclick="setOption('activity', 'Butuh Dukungan Doa', this)" class="option-btn activity-btn p-3 flex items-center justify-center gap-2 col-span-2 bg-gradient-to-r from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100 border-blue-100">
                            <i data-lucide="users" class="w-4 h-4 text-indigo-600"></i> <span class="text-xs font-semibold text-indigo-900">Butuh Dukungan Doa</span>
                        </button>
                    </div>
                </div>

                <!-- Mood Selection -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Perasaan</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setOption('mood', 'Bersyukur', this)" class="option-btn mood-btn py-3 flex flex-col items-center gap-1">
                            <span class="text-xl">üòá</span><span class="text-[10px] font-bold">Bersyukur</span>
                        </button>
                        <button onclick="setOption('mood', 'Lelah', this)" class="option-btn mood-btn py-3 flex flex-col items-center gap-1">
                            <span class="text-xl">üòÆ‚Äçüí®</span><span class="text-[10px] font-bold">Lelah</span>
                        </button>
                        <button onclick="setOption('mood', 'Cemas', this)" class="option-btn mood-btn py-3 flex flex-col items-center gap-1">
                            <span class="text-xl">üòü</span><span class="text-[10px] font-bold">Cemas</span>
                        </button>
                        <button onclick="setOption('mood', 'Sedih', this)" class="option-btn mood-btn py-3 flex flex-col items-center gap-1">
                            <span class="text-xl">üò¢</span><span class="text-[10px] font-bold">Sedih</span>
                        </button>
                        <button onclick="setOption('mood', 'Semangat', this)" class="option-btn mood-btn py-3 flex flex-col items-center gap-1">
                            <span class="text-xl">üî•</span><span class="text-[10px] font-bold">Semangat</span>
                        </button>
                        <button onclick="setOption('mood', 'Takut', this)" class="option-btn mood-btn py-3 flex flex-col items-center gap-1">
                            <span class="text-xl">ü´£</span><span class="text-[10px] font-bold">Takut</span>
                        </button>
                    </div>
                </div>

                <button onclick="generateContent()" id="generateBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-4 rounded-xl font-bold text-sm shadow-xl shadow-blue-200 transition-all flex justify-center items-center gap-2 active:scale-95 transform hover:-translate-y-1">
                    <i data-lucide="sparkles" class="w-4 h-4 animate-pulse"></i>
                    <span>Temukan Ayat & Berkat</span>
                </button>
            </div>
        </section>

        <!-- Result Section -->
        <section id="result-section" class="hidden fade-in space-y-6">
            
            <!-- Dynamic Poster Card -->
            <div class="glass-card p-4 flex flex-col items-center">
                <div id="poster-container">
                    <!-- Background Image (Randomized) -->
                    <div id="poster-bg" class="poster-bg" style="background-image: url('https://images.unsplash.com/photo-1504052434569-70ad5836ab65?q=80&w=1000&auto=format&fit=crop');"></div>
                    <div class="poster-overlay"></div>
                    
                    <div class="relative z-10 h-full flex flex-col justify-between p-6 text-center text-white">
                        <div class="pt-2">
                            <p class="text-[9px] uppercase tracking-[0.3em] opacity-80 font-bold border-b border-white/20 pb-2 inline-block">Warta Iman</p>
                        </div>

                        <div>
                            <p id="poster-user-name" class="font-script text-4xl mb-3 text-yellow-200 drop-shadow-md">Sahabat</p>
                            <div class="font-serif italic text-base md:text-lg leading-relaxed opacity-95 drop-shadow-sm px-2">
                                "<span id="poster-verse-text">Memuat ayat...</span>"
                            </div>
                            <p id="poster-verse-ref" class="text-xs font-bold uppercase tracking-widest mt-4 text-blue-200">...</p>
                        </div>
                        
                        <!-- Poster Footer dengan Ikon Gereja -->
                        <div class="pb-1 w-full flex items-center justify-between border-t border-white/20 pt-3 mt-4">
                            <div class="text-left">
                                <p class="text-[8px] font-bold uppercase tracking-wider opacity-60">Renungan Harian</p>
                                <p class="text-[10px] font-bold">GPIB NEHEMIA</p>
                            </div>
                            <div class="bg-white/90 p-2 rounded-lg backdrop-blur-sm shadow-lg text-blue-900">
                                <i data-lucide="church" class="w-6 h-6"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="w-full mt-6 grid grid-cols-1 gap-3">
                    <div class="grid grid-cols-2 gap-3">
                         <button onclick="changePosterBg()" class="bg-gray-50 hover:bg-gray-100 text-slate-600 py-3 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 border border-slate-200">
                            <i data-lucide="image" class="w-3 h-3"></i> Ganti Background
                        </button>
                        <button onclick="downloadPoster()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg text-xs font-bold shadow-lg shadow-blue-200 transition flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-3 h-3"></i> Simpan Kartu
                        </button>
                    </div>
                    
                    <div class="flex gap-2 justify-center pt-2">
                        <button onclick="shareToWhatsApp()" class="p-3 bg-[#25D366] hover:brightness-110 text-white rounded-full shadow-lg transition transform hover:scale-105">
                            <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        </button>
                        <button onclick="copyContent()" class="p-3 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full shadow-lg transition">
                            <i data-lucide="copy" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Smart Features -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="listenToReflection()" id="ttsBtn" class="bg-gradient-to-r from-violet-500 to-purple-600 text-white p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:brightness-110 transition shadow-lg shadow-purple-200">
                    <i data-lucide="headphones" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold uppercase tracking-widest">Dengar Renungan</span>
                </button>
                <button onclick="getSpiritualCounseling()" id="counselBtn" class="bg-white border-2 border-purple-100 text-purple-700 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-purple-50 transition shadow-lg shadow-purple-100">
                    <i data-lucide="message-circle-heart" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold uppercase tracking-widest">Konseling AI</span>
                </button>
            </div>

            <!-- Full Reflection Content -->
            <div class="glass-card p-6 border-t-4 border-blue-500">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <i data-lucide="scroll" class="w-4 h-4"></i> Renungan Personal
                </h3>
                <div id="reflection-content" class="prose-custom text-sm md:text-base leading-relaxed text-slate-600">
                    <!-- Content injected here -->
                </div>
                <div class="mt-8 text-center border-t border-slate-100 pt-6">
                    <button onclick="resetApp()" class="text-slate-400 hover:text-blue-500 text-xs font-bold uppercase tracking-widest transition">
                        ‚Üê Buat Renungan Baru
                    </button>
                </div>
            </div>

        </section>
    </main>

    <footer class="text-center py-10 text-slate-400 text-[10px] uppercase tracking-widest">
        <p class="font-bold text-slate-300">Multimedia GPIB Nehemia Cibogo</p>
        <p class="mt-1">Membangun Jemaat Menjadi Berkat</p>
    </footer>

    <!-- Counseling Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-end md:items-center justify-center p-4 transition-opacity opacity-0">
        <div id="modal-content" class="bg-white rounded-t-3xl md:rounded-3xl max-w-md w-full max-h-[80vh] flex flex-col shadow-2xl transform translate-y-10 transition-transform">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-purple-50 rounded-t-3xl md:rounded-t-3xl">
                <div class="flex items-center gap-3">
                    <span class="p-2 bg-white rounded-lg shadow-sm text-purple-600"><i data-lucide="heart-handshake" class="w-5 h-5"></i></span>
                    <h3 class="font-bold text-purple-900">Bimbingan Rohani</h3>
                </div>
                <button onclick="toggleModal(false)" class="text-slate-400 hover:text-slate-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div id="counseling-body" class="text-sm leading-relaxed text-slate-600 space-y-4"></div>
            </div>
            <div class="p-4 border-t border-slate-100 text-center bg-slate-50 rounded-b-3xl md:rounded-b-3xl">
                <p class="text-[10px] text-slate-400 italic">Konseling ini berbasis AI. Hubungi Pendeta untuk konseling pastoral lebih lanjut.</p>
            </div>
        </div>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // State & Config
        const apiKey = "AIzaSyCtMsZtisHkjzOhHfEFR7mDDY8WllBFhBc"; // PENTING: Jika dihosting di GitHub, Anda perlu memasukkan API Key Gemini Anda di sini atau gunakan server backend.
        let state = { name: '', activity: '', mood: '', generatedText: '', isPlaying: false, verse: '', verseRef: '' };
        
        // Background Images for Poster
        const bgImages = [
            'https://images.unsplash.com/photo-1504052434569-70ad5836ab65?q=80&w=1000&auto=format&fit=crop', // Blue/Cloud
            'https://images.unsplash.com/photo-1518495973542-4542c06a5843?q=80&w=1000&auto=format&fit=crop', // Forest
            'https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=80&w=1000&auto=format&fit=crop', // Sunrise
            'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1000&auto=format&fit=crop', // Sea
            'https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1000&auto=format&fit=crop'  // Mountain
        ];

        // --- UI Interactions ---

        function setOption(type, value, btnElement) {
            state[type] = value;
            document.querySelectorAll(`.${type}-btn`).forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast-container');
            const msgEl = document.getElementById('toast-message');
            msgEl.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleModal(show) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            if (show) {
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    content.classList.remove('translate-y-10');
                }, 10);
            } else {
                overlay.classList.add('opacity-0');
                content.classList.add('translate-y-10');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function changePosterBg() {
            const randomImg = bgImages[Math.floor(Math.random() * bgImages.length)];
            document.getElementById('poster-bg').style.backgroundImage = `url('${randomImg}')`;
        }

        function resetApp() {
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('input-section').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
            state.generatedText = '';
        }

        // --- Core Logic (Gemini AI) ---

        async function callGemini(systemInstruction, userPrompt) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

            try {
                // Catatan: Jika dihosting publik, mengekspos API Key di sini berisiko. 
                // Gunakan backend proxy untuk keamanan lebih baik pada aplikasi produksi.
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini Error:", error);
                throw error;
            }
        }

        async function generateContent() {
            state.name = document.getElementById('userName').value.trim();
            
            if (!state.name || !state.activity || !state.mood) {
                showToast("Mohon lengkapi nama, aktivitas, dan mood.", "error");
                return;
            }

            const btn = document.getElementById('generateBtn');
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = `<div class="spinner"></div><span>Sedang Berdoa & Berpikir...</span>`;
            btn.disabled = true;

            const systemPrompt = `
                Anda adalah asisten rohani Kristen GPIB yang hangat, berempati, dan puitis. 
                Tugas:
                1. Pilih SATU ayat Alkitab yang SANGAT SPESIFIK dan MENENANGKAN untuk kondisi user.
                2. Berikan renungan singkat (2 paragraf).
                3. Berikan doa pendek.
                
                OUTPUT JSON MURNI (Tanpa Markdown):
                {
                    "ayat": "Isi ayat lengkap",
                    "referensi": "Kitab Pasal:Ayat",
                    "renungan": "Isi renungan dalam HTML (gunakan <p> dan <strong>)",
                    "doa": "Isi doa"
                }
            `;
            
            const userPrompt = `User: ${state.name}, Sedang: ${state.activity}, Perasaan: ${state.mood}.`;

            try {
                let text = await callGemini(systemPrompt, userPrompt);
                // Clean markdown if present
                text = text.replace(/```json|```/g, '').trim();
                const data = JSON.parse(text);

                state.generatedText = `${data.ayat} (${data.referensi}). ${data.renungan.replace(/<[^>]*>/g, '')} ${data.doa}`;
                state.verse = data.ayat;
                state.verseRef = data.referensi;

                // Update UI
                document.getElementById('poster-user-name').textContent = state.name;
                document.getElementById('poster-verse-text').textContent = data.ayat;
                document.getElementById('poster-verse-ref').textContent = data.referensi;
                
                document.getElementById('reflection-content').innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-xl mb-4 border-l-4 border-blue-400">
                        <p class="font-bold text-blue-900 text-lg">" ${data.ayat} "</p>
                        <p class="text-right text-xs font-bold text-blue-500 mt-2 uppercase tracking-wider">‚Äî ${data.referensi}</p>
                    </div>
                    ${data.renungan}
                    <div class="bg-yellow-50 p-4 rounded-xl mt-4 border border-yellow-200">
                        <p class="font-bold text-yellow-800 text-xs uppercase mb-2">üôè Doa Bersama</p>
                        <p class="italic text-slate-700">"${data.doa}"</p>
                    </div>
                `;

                document.getElementById('input-section').classList.add('hidden');
                document.getElementById('result-section').classList.remove('hidden');
                window.scrollTo({top: 0, behavior: 'smooth'});
                showToast("Renungan siap!", "success");

            } catch (error) {
                showToast("Maaf, jaringan sedang sibuk. Coba lagi ya.", "error");
            } finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        }

        async function getSpiritualCounseling() {
            const btn = document.getElementById('counselBtn');
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = `<div class="spinner border-purple-500 border-t-transparent"></div>`;
            btn.disabled = true;

            try {
                const prompt = `
                    Berdasarkan renungan sebelumnya: "${state.generatedText}", berikan 3 langkah praktis iman Kristen untuk ${state.name} yang sedang merasa ${state.mood}.
                    Gunakan format HTML list (<ul><li>). Nada bicara seperti Pendeta yang kebapakan/keibuan.
                `;
                const result = await callGemini(prompt, "Berikan saran praktis.");
                
                document.getElementById('counseling-body').innerHTML = result;
                toggleModal(true);
            } catch (e) {
                showToast("Gagal memuat konseling.", "error");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // --- TTS Logic ---

        async function listenToReflection() {
            if (state.isPlaying) return;
            
            const btn = document.getElementById('ttsBtn');
            const icon = btn.querySelector('i');
            const textSpan = btn.querySelector('span');
            
            const originalIcon = icon.innerHTML; // lucide svg content
            
            // Set Loading UI
            textSpan.textContent = "Menyiapkan...";
            btn.classList.add('animate-pulse');

            try {
                // Truncate text for TTS limit if necessary
                const textToRead = `Syalom ${state.name}. ${state.generatedText}`.substring(0, 500);

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: textToRead }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } 
                        }
                    })
                });

                const result = await response.json();
                
                if(!result.candidates) throw new Error("No audio");
                
                const pcmData = result.candidates[0].content.parts[0].inlineData.data;
                playAudio(pcmData);

                // Playing UI
                state.isPlaying = true;
                textSpan.textContent = "Mendengarkan...";
                btn.classList.remove('animate-pulse');
                btn.classList.replace('from-violet-500', 'from-pink-500'); // Change color indicating active

            } catch (e) {
                showToast("Gagal memutar suara.", "error");
                resetTTSButton(btn, textSpan);
            }
        }

        function playAudio(base64Data) {
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

            const wavHeader = createWavHeader(len, 24000); // Gemini TTS is 24kHz
            const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            
            audio.onended = () => {
                const btn = document.getElementById('ttsBtn');
                const textSpan = btn.querySelector('span');
                resetTTSButton(btn, textSpan);
            };
            
            audio.play();
        }

        function resetTTSButton(btn, textSpan) {
            state.isPlaying = false;
            textSpan.textContent = "Dengar Renungan";
            btn.classList.remove('animate-pulse');
            btn.classList.replace('from-pink-500', 'from-violet-500');
        }

        function createWavHeader(dataLength, sampleRate) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            // RIFF chunk descriptor
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, 36 + dataLength, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"
            // fmt sub-chunk
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, 1, true); // NumChannels (1 for Mono)
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * 2, true); // ByteRate
            view.setUint16(32, 2, true); // BlockAlign
            view.setUint16(34, 16, true); // BitsPerSample
            // data sub-chunk
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, dataLength, true);
            return buffer;
        }

        // --- Export/Share ---

        function downloadPoster() {
            const container = document.getElementById('poster-container');
            const btn = document.querySelector('button[onclick="downloadPoster()"]');
            
            btn.innerHTML = `<div class="spinner w-3 h-3"></div> Loading`;
            
            // Use html2canvas
            html2canvas(container, {
                useCORS: true,
                scale: 3, // High Res
                backgroundColor: null,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Ayat-Harian-${state.name}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Kartu berhasil disimpan!");
                btn.innerHTML = `<i data-lucide="download" class="w-3 h-3"></i> Simpan Kartu`;
                lucide.createIcons();
            }).catch(err => {
                showToast("Gagal menyimpan gambar.", "error");
                btn.innerHTML = `<i data-lucide="download" class="w-3 h-3"></i> Simpan Kartu`;
                lucide.createIcons();
            });
        }

        function getShareText() {
            return `*Renungan Harian GPIB Nehemia*\n\n"${state.verse}"\n(${state.verseRef})\n\nTetap semangat ${state.name}! Tuhan Yesus Memberkati.`;
        }

        function shareToWhatsApp() {
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(getShareText())}`, '_blank');
        }

        function copyContent() {
            navigator.clipboard.writeText(getShareText()).then(() => {
                showToast("Teks disalin ke clipboard!");
            }).catch(() => {
                // Fallback
                const el = document.createElement('textarea');
                el.value = getShareText();
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showToast("Teks disalin!");
            });
        }
    </script>
</body>
</html>
